{% extends "rrggweb/quotation/insurance/vehicle/base.html" %}
{% load i18n %}
{% block title_section %}
  {{ title }}
  <h6>{{ subtitle }}</h6>
{% endblock title_section %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-10">
    {% if step %}
      {% include "rrggweb/utils/stepper.html" with step=6 max_step=6 %}
    {% endif %}
    <a class="btn btn-outline-dark btn-sm mb-3" href="{{ previous_page }}">
      <i class="fas fa-long-arrow-alt-left"></i>Volver
    </a>
    {% if seller or customer or vehicle or quotation %}
      <div class="mt-2">
        <h5>
          Asesor: <b>{{ seller }}</b>
        </h5>
        <h5>
          Contratante: <b>{{ customer }}</b>
        </h5>
        <h5>
          Veh√≠culo: <b>{{ vehicle }}</b>
        </h5>
        <h5>
          Propietario: <b>{{ owner }}</b>
        </h5>
        <h5>
          Tipo de moneda: <b>{{ quotation.currency.name }}</b>
        </h5>
        <h5>
          Suma Asegurada: <b><span id="insured_amount">{{ quotation.insured_amount }}</span></b>
        </h5>
        <hr class="w-25"/>
      </div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      {% translate "emission right" as emission_right_text %}
      {% translate "tax (igv)" as tax_text %}
      {% translate "vehicle insurance" as vehicle_insurance_text %}
      {% translate "created at" as created_at_text %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
              <th>{{ emission_right_text|capfirst }}</th>
              <th>{{ tax_text|capfirst }}</th>
              <th>{{ vehicle_insurance_text|capfirst }}</th>
              <th>Prima neta</th>
              <th>Tasa</th>
            </tr>
          </thead>
          <tbody>
            {% for ratio, form in last_ratio_forms %}
            <tr>
              <td>{% widthratio ratio.emission_right 1 100 %}%</td>
              <td>{% widthratio ratio.tax 1 100 %}%</td>
              <td>{{ ratio.insurance_vehicle.name }}</td>
              <td>
                <div class="input-group">
                  {{ form.amount }}
                  {% if form.errors %}
                  <div class="alert alert-danger" role="alert">
                    {{ form.errors }}
                  </div>
                  {% endif %}
                  {{ form.insurance_vehicle_ratio }}
                  {{ form.quotation_insurance_vehicle }}
                  {{ form.id }}
                </div>
              </td>
              <td>{{ form.rate }}</td>
            </tr>
            {% endfor %}
          </tbody>
          {{ form.management_form }}
        </table>
      </div>
      <div class="alert alert-danger mt-2" role="alert" id="note" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        Por favor complete al menos un campo antes de continuar.
      </div>
      <button id="btn-create-premium" class="btn btn-primary btn-block mt-3" type="submit" disabled>Finalizar</button>
    </form>
  </div>
</div>
<script>
  const insuredAmount = Number(document.querySelector('#insured_amount').textContent);

  for (let i = 0; i <= 4; i++) {
    const amountInput = document.querySelector(`#id_form-${i}-amount`);
    const rateInput = document.querySelector(`#id_form-${i}-rate`);

    amountInput.classList.add('form-control');
    rateInput.classList.add('form-control');

    amountInput.addEventListener('input', () => {
      const amount = Number(amountInput.value);
      const rate = insuredAmount / amount;
      rateInput.value = rate.toFixed(2);
    });
  }

  const amountInputs = document.querySelectorAll('[id^="id_form-"][id$="-amount"]');
  const submitButton = document.querySelector('#btn-create-premium');
  const note = document.querySelector('#note');

  function checkAmountInputs() {
    let hasValueGreaterThanOne = false;
    amountInputs.forEach((input) => {
      const amount = Number(input.value);
      if (amount > 1) {
        hasValueGreaterThanOne = true;
      }
    });
    submitButton.disabled = !hasValueGreaterThanOne;
    note.style.display = hasValueGreaterThanOne ? 'none' : 'block';
  }

  amountInputs.forEach((input) => {
    input.addEventListener('input', () => {
      checkAmountInputs();
    });
  });

  checkAmountInputs();
</script>
{% endblock content %}
